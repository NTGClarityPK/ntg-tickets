generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String             @id @default(uuid())
  name           String
  slug           String             @unique
  domain         String?            @unique
  isActive       Boolean            @default(true)
  plan           String             @default("FREE")
  maxUsers       Int                @default(10)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  auditLogs      AuditLog[]
  categories     Category[]
  customFields   CustomField[]
  emailTemplates EmailTemplate[]
  integrations   Integration[]
  notifications  Notification[]
  savedSearches  SavedSearch[]
  systemSettings SystemSettings[]
  invitations    TenantInvitation[]
  themeSettings  ThemeSettings[]
  tickets        Ticket[]
  users          User[]
  workflows      Workflow[]

  @@index([slug])
  @@index([isActive])
  @@map("tenants")
}

model TenantInvitation {
  id         String     @id @default(uuid())
  tenantId   String
  email      String
  name       String?
  roles      UserRole[]
  invitedBy  String
  token      String     @unique @default(uuid())
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime   @default(now())
  inviter    User       @relation("InvitationSender", fields: [invitedBy], references: [id])
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("tenant_invitations")
}

model User {
  id                   String              @id @default(uuid())
  email                String              @unique
  name                 String
  password             String?
  roles                UserRole[]          @default([END_USER])
  isActive             Boolean             @default(true)
  avatar               String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  tenantId             String
  attachments          Attachment[]
  auditLogs            AuditLog[]
  createdCategories    Category[]          @relation("CategoryCreator")
  comments             Comment[]
  notifications        Notification[]
  savedSearches        SavedSearch[]
  createdSubcategories Subcategory[]       @relation("SubcategoryCreator")
  sentInvitations      TenantInvitation[]  @relation("InvitationSender")
  ticketHistory        TicketHistory[]
  assignedTickets      Ticket[]            @relation("TicketAssignee")
  requestedTickets     Ticket[]            @relation("TicketRequester")
  tenant               Tenant              @relation(fields: [tenantId], references: [id])
  workflowExecutions   WorkflowExecution[]
  createdWorkflows     Workflow[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Category {
  id            String         @id @default(uuid())
  name          TicketCategory
  customName    String?
  description   String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String
  tenantId      String
  creator       User           @relation("CategoryCreator", fields: [createdBy], references: [id])
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  subcategories Subcategory[]
  tickets       Ticket[]

  @@unique([tenantId, customName])
  @@index([tenantId])
  @@map("categories")
}

model Subcategory {
  id          String   @id @default(uuid())
  categoryId  String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  creator     User     @relation("SubcategoryCreator", fields: [createdBy], references: [id])
  tickets     Ticket[]

  @@unique([name, categoryId])
  @@map("subcategories")
}

model Ticket {
  id                 String              @id @default(uuid())
  ticketNumber       String              @unique
  title              String
  description        String
  categoryId         String
  subcategoryId      String?
  priority           TicketPriority      @default(MEDIUM)
  impact             TicketImpact        @default(MODERATE)
  urgency            TicketUrgency       @default(NORMAL)
  requesterId        String
  assignedToId       String?
  dueDate            DateTime?
  resolution         String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  closedAt           DateTime?
  workflowId         String?
  workflowSnapshot   Json?
  workflowVersion    Int?
  status             String              @default("NEW")
  tenantId           String
  attachments        Attachment[]
  comments           Comment[]
  notifications      Notification[]
  customFields       TicketCustomField[]
  history            TicketHistory[]
  relatedToTickets   TicketRelation[]    @relation("RelatedTicketRelations")
  relatedTickets     TicketRelation[]    @relation("TicketRelations")
  assignedTo         User?               @relation("TicketAssignee", fields: [assignedToId], references: [id])
  category           Category            @relation(fields: [categoryId], references: [id])
  requester          User                @relation("TicketRequester", fields: [requesterId], references: [id])
  subcategory        Subcategory?        @relation(fields: [subcategoryId], references: [id])
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  workflow           Workflow?           @relation(fields: [workflowId], references: [id])
  workflowExecutions WorkflowExecution[]

  @@index([tenantId])
  @@index([status])
  @@index([assignedToId])
  @@index([requesterId])
  @@index([categoryId, subcategoryId])
  @@index([createdAt])
  @@map("tickets")
}

model Comment {
  id         String   @id @default(uuid())
  ticketId   String
  userId     String
  content    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

model Attachment {
  id         String   @id @default(uuid())
  ticketId   String
  filename   String
  fileSize   Int
  fileType   String
  fileUrl    String
  uploadedBy String
  createdAt  DateTime @default(now())
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploader   User     @relation(fields: [uploadedBy], references: [id])

  @@index([ticketId])
  @@index([uploadedBy])
  @@index([createdAt])
  @@map("attachments")
}

model TicketHistory {
  id        String   @id @default(uuid())
  ticketId  String
  userId    String
  fieldName String
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("ticket_history")
}

model TicketRelation {
  id              String @id @default(uuid())
  ticketId        String
  relatedTicketId String
  relationType    String
  relatedTicket   Ticket @relation("RelatedTicketRelations", fields: [relatedTicketId], references: [id], onDelete: Cascade)
  ticket          Ticket @relation("TicketRelations", fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, relatedTicketId])
  @@index([ticketId])
  @@index([relatedTicketId])
  @@map("ticket_relations")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  ticketId  String?
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  tenantId  String
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  ticket    Ticket?          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model CustomField {
  id                 String              @id @default(uuid())
  name               String
  fieldType          CustomFieldType
  options            Json?
  isRequired         Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  category           String?
  description        String?
  tenantId           String
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  ticketCustomFields TicketCustomField[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("custom_fields")
}

model TicketCustomField {
  id            String      @id @default(uuid())
  ticketId      String
  customFieldId String
  value         String
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  ticket        Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, customFieldId])
  @@index([ticketId])
  @@index([customFieldId])
  @@map("ticket_custom_fields")
}

model EmailTemplate {
  id        String   @id @default(uuid())
  name      String
  type      String
  subject   String
  html      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([tenantId, type, isActive])
  @@map("email_templates")
}

model SavedSearch {
  id             String   @id @default(uuid())
  name           String
  description    String?
  searchCriteria String
  userId         String
  isPublic       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@map("saved_searches")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  action     AuditAction
  resource   String
  resourceId String?
  fieldName  String?
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime    @default(now())
  tenantId   String
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  user       User        @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSettings {
  id        String   @id @default(uuid())
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("system_settings")
}

model ThemeSettings {
  id           String   @id @default(uuid())
  primaryColor String?
  logoUrl      String?
  faviconUrl   String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  faviconData  String?
  logoData     String?
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("theme_settings")
}

model Integration {
  id           String   @id @default(uuid())
  name         String
  type         String
  enabled      Boolean  @default(false)
  config       Json     @default("{}")
  credentials  Json     @default("{}")
  webhookUrl   String?
  apiKey       String?
  clientId     String?
  clientSecret String?
  tenantId     String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("integrations")
}

model Workflow {
  id              String               @id @default(uuid())
  name            String
  description     String?
  status          WorkflowStatus       @default(DRAFT)
  isDefault       Boolean              @default(false)
  version         Int                  @default(1)
  definition      Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdBy       String
  deletedAt       DateTime?
  isSystemDefault Boolean              @default(false)
  doneStatuses    String[]             @default([])
  isActive        Boolean              @default(true)
  workingStatuses String[]             @default([])
  tenantId        String
  tickets         Ticket[]
  executions      WorkflowExecution[]
  transitions     WorkflowTransition[]
  createdByUser   User                 @relation(fields: [createdBy], references: [id])
  tenant          Tenant               @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status, isActive])
  @@index([createdBy])
  @@index([createdAt])
  @@map("workflows")
}

model WorkflowTransition {
  id          String               @id @default(uuid())
  workflowId  String
  fromState   String
  toState     String
  name        String
  description String?
  isActive    Boolean              @default(true)
  order       Int                  @default(0)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  actions     WorkflowAction[]
  conditions  WorkflowCondition[]
  permissions WorkflowPermission[]
  workflow    Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, isActive])
  @@index([fromState, toState])
  @@map("workflow_transitions")
}

model WorkflowCondition {
  id           String                @id @default(uuid())
  transitionId String
  type         WorkflowConditionType
  value        String?
  createdAt    DateTime              @default(now())
  isActive     Boolean               @default(true)
  transition   WorkflowTransition    @relation(fields: [transitionId], references: [id], onDelete: Cascade)

  @@map("workflow_conditions")
}

model WorkflowAction {
  id           String             @id @default(uuid())
  transitionId String
  type         WorkflowActionType
  config       Json               @default("{}")
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  transition   WorkflowTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)

  @@map("workflow_actions")
}

model WorkflowPermission {
  id           String             @id @default(uuid())
  transitionId String
  role         UserRole
  canExecute   Boolean            @default(true)
  createdAt    DateTime           @default(now())
  isActive     Boolean            @default(true)
  transition   WorkflowTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)

  @@map("workflow_permissions")
}

model WorkflowExecution {
  id           String   @id @default(uuid())
  ticketId     String
  workflowId   String
  fromState    String?
  toState      String?
  transitionId String?
  executedBy   String
  executedAt   DateTime @default(now())
  comment      String?
  metadata     Json?
  errorMessage String?
  result       String?
  user         User     @relation(fields: [executedBy], references: [id])
  ticket       Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  workflow     Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([workflowId])
  @@index([executedBy])
  @@index([executedAt])
  @@map("workflow_executions")
}

enum UserRole {
  END_USER
  SUPPORT_STAFF
  SUPPORT_MANAGER
  ADMIN
}

enum TicketStatus {
  NEW
  OPEN
  IN_PROGRESS
  ON_HOLD
  RESOLVED
  CLOSED
  REOPENED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketCategory {
  HARDWARE
  SOFTWARE
  NETWORK
  ACCESS
  OTHER
  CUSTOM
}

enum TicketImpact {
  MINOR
  MODERATE
  MAJOR
  CRITICAL
}

enum TicketUrgency {
  LOW
  NORMAL
  HIGH
  IMMEDIATE
}

enum NotificationType {
  TICKET_CREATED
  TICKET_ASSIGNED
  TICKET_STATUS_CHANGED
  COMMENT_ADDED
  TICKET_DUE
  TICKET_ESCALATED
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  BOOLEAN
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ASSIGN
  ESCALATE
  COMMENT
  ATTACH
  STATUS_CHANGE
  PRIORITY_CHANGE
  CATEGORY_CHANGE
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum WorkflowConditionType {
  REQUIRES_COMMENT
  REQUIRES_RESOLUTION
  REQUIRES_ASSIGNEE
  CUSTOM_FIELD_VALUE
}

enum WorkflowActionType {
  SEND_NOTIFICATION
  ASSIGN_USER
  UPDATE_FIELD
  SEND_EMAIL
  CREATE_TASK
}
